name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  buildAndTest:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install OpenUMP CLI
        run: npm install -g openupm-cli

      - name: Restore
        run: dotnet restore KerwinTesting.sln

      - name: Install NSubstitute
        run: dotnet add KerwinTesting.Tests/KerwinTesting.Tests.csproj package NSubstitute

  runEditModeTests:
    needs: buildAndTest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install OpenUMP CLI
        run: npm install -g openupm-cli

      - name: Restore
        run: dotnet restore KerwinTesting.sln

      - name: Install NSubstitute
        run: dotnet add KerwinTesting.Tests/KerwinTesting.Tests.csproj package NSubstitute
      
      - name: Run EditMode Tests
        run: |
          cd KerwinTesting.Tests
          dotnet test KerwinTesting.Tests.csproj --filter "FullyQualifiedName~EditMode"


  runPlayModeTests:
    needs: buildAndTest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install OpenUMP CLI
        run: npm install -g openupm-cli

      - name: Restore
        run: dotnet restore KerwinTesting.sln

      - name: Install NSubstitute
        run: dotnet add KerwinTesting.Tests/KerwinTesting.Tests.csproj package NSubstitute
      
      - name: Run PlayMode Tests
        run: |
          cd KerwinTesting.Tests
          dotnet test KerwinTesting.Tests.csproj --filter "FullyQualifiedName~PlayMode"

      - name: Run Build Artifact
        run: |
          cd KerwinTesting
          dotnet build KerwinTesting.sln

  build-artifact:
    name: Artifact Production Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install OpenUMP CLI
        run: npm install -g openupm-cli

      - name: Restore
        run: dotnet restore KerwinTesting.sln

      - name: Install NSubstitute
        run: dotnet add KerwinTesting.Tests/KerwinTesting.Tests.csproj package NSubstitute

      - name: Upload Next.js Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MathFunAdventure-Production-Build
          path: KerwinTesting/bin/Debug/net10.0/
          include-hidden-files: true
          retention-days: 7
  # =========================
  # ðŸ“Š Test Summary
  # =========================
  test-summary:
    name: Test Summary
    needs:
      - build-artifact
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: All Tests Complete
        run: echo "All test suites have completed (or at least attempted)!"
